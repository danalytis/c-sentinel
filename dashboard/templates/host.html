{% extends "base.html" %}

{% block title %}{{ hostname }} - C-Sentinel{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    pre { white-space: pre-wrap; word-wrap: break-word; }
    
    .chart-container {
        position: relative;
        height: 200px;
        width: 100%;
    }
    
    .event-type-auth_failure { border-left-color: #ef4444 !important; }
    .event-type-brute_force { border-left-color: #dc2626 !important; }
    .event-type-sudo { border-left-color: #3b82f6 !important; }
    .event-type-file_access { border-left-color: #f59e0b !important; }
    .event-type-selinux_denial { border-left-color: #8b5cf6 !important; }
    .event-type-apparmor_denial { border-left-color: #8b5cf6 !important; }
    
    .risk-low { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
    .risk-medium { background: rgba(234, 179, 8, 0.2); color: #eab308; border: 1px solid rgba(234, 179, 8, 0.3); }
    .risk-high { background: rgba(249, 115, 22, 0.2); color: #f97316; border: 1px solid rgba(249, 115, 22, 0.3); }
    .risk-critical { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
    
    .status-ok { color: #10b981; }
    .status-warning { color: #f59e0b; }
    .status-critical { color: #ef4444; }
</style>
{% endblock %}

{% block header_back %}
{{ back_button('/') }}
{% endblock %}

{% block header_icon_block %}<i data-lucide="server"></i>{% endblock %}
{% block header_title %}{{ hostname }}{% endblock %}
{% block header_subtitle %}<span id="host-status">Loading...</span>{% endblock %}

{% block header_extra %}
<div id="risk-badge" class="hide-mobile" style="display: none; margin-left: 1rem;">
    <span class="px-3 py-1 rounded-full text-sm font-semibold">
        Risk: <span id="risk-level">-</span>
    </span>
</div>
{% endblock %}

{% block content %}
<!-- Quick Stats -->
<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-8">
    {{ stat_card('Memory', '-', 'stat-memory') }}
    {{ stat_card('Load (1m)', '-', 'stat-load') }}
    {{ stat_card('Processes', '-', 'stat-processes') }}
    {{ stat_card('Zombies', '-', 'stat-zombies') }}
    {{ stat_card('Listeners', '-', 'stat-listeners') }}
    {{ stat_card('Uptime', '-', 'stat-uptime') }}
    <div id="stat-risk-card" class="stat-card" style="display: none;">
        <div class="stat-card__label">Risk Score</div>
        <div class="stat-card__value" id="stat-risk">-</div>
    </div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="card">
        <div class="card__body">
            <h3 class="text-xs font-semibold text-muted uppercase tracking-wide mb-4">Memory Usage (24h)</h3>
            <div class="chart-container">
                <canvas id="memory-chart"></canvas>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card__body">
            <h3 class="text-xs font-semibold text-muted uppercase tracking-wide mb-4">Load Average (24h)</h3>
            <div class="chart-container">
                <canvas id="load-chart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="mb-6">
    <div class="tabs">
        <button onclick="showTab('security')" id="tab-security" class="tab-btn active">
            <i data-lucide="shield" class="w-4 h-4 inline mr-1"></i>Security
        </button>
        <button onclick="showTab('events')" id="tab-events" class="tab-btn">
            <i data-lucide="history" class="w-4 h-4 inline mr-1"></i>Event History
        </button>
        <button onclick="showTab('network')" id="tab-network" class="tab-btn">
            Network
        </button>
        <button onclick="showTab('processes')" id="tab-processes" class="tab-btn">
            Processes
        </button>
        <button onclick="showTab('configs')" id="tab-configs" class="tab-btn">
            Configs
        </button>
        <button onclick="showTab('raw')" id="tab-raw" class="tab-btn">
            Raw JSON
        </button>
    </div>
</div>

<!-- Tab Content: Security -->
<div id="content-security" class="tab-content" style="display: block;">
    <div id="security-disabled" class="card p-8 text-center" style="display: none;">
        <i data-lucide="shield-off" class="w-12 h-12 mx-auto mb-4" style="color: var(--text-muted);"></i>
        <h3 class="text-lg font-semibold mb-2">Audit Not Enabled</h3>
        <p class="text-muted mb-4">Run sentinel with --audit flag to enable security monitoring.</p>
        <code class="text-xs bg-recessed px-3 py-2 rounded" style="color: var(--color-brand);">sudo sentinel --json --network --audit</code>
    </div>
    
    <div id="security-content" class="space-y-6">
        <!-- Security Posture Summary -->
        <div id="posture-summary" class="card">
            <div class="card__body">
                <div class="flex items-start gap-4">
                    <div id="posture-icon" class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center" style="background: var(--color-success-muted);">
                        <i data-lucide="shield-check" class="w-6 h-6" style="color: var(--color-success);"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="text-lg font-semibold">Security Posture</h3>
                            <span id="posture-badge" class="px-2 py-0.5 rounded text-xs font-bold" style="background: var(--color-success-muted); color: var(--color-success);">HEALTHY</span>
                        </div>
                        <p id="posture-text" class="text-secondary leading-relaxed">
                            Analyzing security posture...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Score Card -->
        <div class="card">
            <div class="card__body">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <h3 class="text-lg font-semibold">Security Risk Assessment</h3>
                        <div id="learning-badge" class="px-2 py-1 rounded text-xs font-medium" style="display: none; background: var(--color-info-muted); color: var(--color-info);">
                            <span class="inline-flex items-center">
                                <i data-lucide="brain" class="w-3 h-3 mr-1"></i>
                                <span id="learning-label">Learning</span>:&nbsp;<span id="sample-count">0</span>&nbsp;samples
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <canvas id="risk-sparkline" width="100" height="30" style="opacity: 0.75;"></canvas>
                            <span class="text-xs text-muted">24h</span>
                        </div>
                        <div id="risk-score-badge" class="px-4 py-2 rounded-lg text-lg font-bold risk-low">
                            Score: <span id="security-score">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Current Period Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="p-3 rounded" style="background: var(--bg-recessed);">
                        <div class="text-muted text-xs mb-1">Auth Failures (recent)</div>
                        <div id="sec-auth-failures" class="text-xl font-mono">-</div>
                    </div>
                    <div class="p-3 rounded" style="background: var(--bg-recessed);">
                        <div class="text-muted text-xs mb-1">Sudo Commands (recent)</div>
                        <div id="sec-sudo-count" class="text-xl font-mono">-</div>
                    </div>
                    <div class="p-3 rounded" style="background: var(--bg-recessed);">
                        <div class="text-muted text-xs mb-1">File Access (recent)</div>
                        <div id="sec-file-access" class="text-xl font-mono">-</div>
                    </div>
                    <div class="p-3 rounded" style="background: var(--bg-recessed);">
                        <div class="text-muted text-xs mb-1">SELinux Denials</div>
                        <div id="sec-selinux" class="text-xl font-mono">-</div>
                    </div>
                </div>
                
                <!-- Cumulative Totals -->
                <div id="cumulative-totals" class="p-4 rounded-lg mb-4" style="background: var(--bg-recessed);">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h4 class="text-sm font-semibold">Cumulative Totals</h4>
                            <p id="totals-since" class="text-xs text-muted">Since: -</p>
                        </div>
                        <button id="reset-btn" onclick="resetAuditTotals()" class="btn btn--secondary btn--sm">
                            <i data-lucide="refresh-cw"></i>
                            <span>Reset</span>
                        </button>
                    </div>
                    <div class="grid grid-cols-4 gap-4">
                        <div class="text-center">
                            <div id="total-auth-failures" class="text-2xl font-mono text-muted">0</div>
                            <div class="text-xs text-muted">Auth Failures</div>
                        </div>
                        <div class="text-center">
                            <div id="total-sudo-count" class="text-2xl font-mono text-muted">0</div>
                            <div class="text-xs text-muted">Sudo Commands</div>
                        </div>
                        <div class="text-center">
                            <div id="total-file-access" class="text-2xl font-mono text-muted">0</div>
                            <div class="text-xs text-muted">File Access</div>
                        </div>
                        <div class="text-center">
                            <div id="total-brute-force" class="text-2xl font-mono text-muted">0</div>
                            <div class="text-xs text-muted">Brute Force</div>
                        </div>
                    </div>
                </div>
                
                <!-- Brute Force Alert -->
                <div id="brute-force-alert" class="alert alert--danger" style="display: none;">
                    <i data-lucide="alert-octagon"></i>
                    <div>
                        <div class="font-semibold">Brute Force Detected</div>
                        <div class="text-sm">Multiple authentication failures detected in recent window</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Risk Factors -->
        <div class="card">
            <div class="card__body">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Why This Score?</h3>
                    <span id="risk-factors-total" class="text-sm text-muted"></span>
                </div>
                <div id="risk-factors-list">
                    <div class="flex items-center justify-center py-8 text-muted">
                        <i data-lucide="shield-check" class="w-8 h-8 mr-3" style="color: var(--color-success);"></i>
                        <span>No risk factors detected — system is clean</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- File Access Table -->
        <div class="card">
            <div class="card__body">
                <h3 class="text-lg font-semibold mb-4">Sensitive File Access (Recent)</h3>
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Path</th>
                                <th>Process</th>
                                <th>Count</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="file-access-table">
                            <tr><td colspan="4" class="text-center py-8 text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Anomalies -->
        <div class="card">
            <div class="card__body">
                <h3 class="text-lg font-semibold mb-4">Detected Anomalies</h3>
                <div id="anomalies-list">
                    <p class="text-muted text-center py-4">Loading...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tab Content: Event History -->
<div id="content-events" class="tab-content" style="display: none;">
    <div class="card">
        <div class="card__body">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
                <h3 class="text-lg font-semibold">Audit Event History</h3>
                <div class="flex items-center gap-2 flex-wrap">
                    <select id="event-filter" onchange="loadEvents()" class="form-input form-select" style="width: auto;">
                        <option value="">All Events</option>
                        <option value="auth_failure">Auth Failures</option>
                        <option value="brute_force">Brute Force</option>
                        <option value="sudo">Sudo Commands</option>
                        <option value="file_access">File Access</option>
                        <option value="selinux_denial">SELinux Denials</option>
                        <option value="apparmor_denial">AppArmor Denials</option>
                    </select>
                    <label class="flex items-center text-sm text-muted">
                        <input type="checkbox" id="show-acknowledged" onchange="loadEvents()" class="mr-2">
                        Show acknowledged
                    </label>
                    <button onclick="acknowledgeAllEvents()" class="btn btn--secondary btn--sm">
                        Acknowledge All
                    </button>
                </div>
            </div>
            
            <div id="events-list" class="space-y-2">
                <p class="text-muted text-center py-8">Loading events...</p>
            </div>
            
            <div id="events-empty" class="text-center py-8 text-muted" style="display: none;">
                <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-2" style="color: var(--color-success);"></i>
                <p>No unacknowledged events</p>
            </div>
        </div>
    </div>
</div>

<!-- Tab Content: Network -->
<div id="content-network" class="tab-content" style="display: none;">
    <div class="card">
        <div class="card__body">
            <h3 class="text-lg font-semibold mb-4">Listening Ports</h3>
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Address</th>
                            <th>Port</th>
                            <th>Protocol</th>
                            <th>Process</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="network-table">
                        <tr><td colspan="5" class="text-center py-8 text-muted">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Tab Content: Processes -->
<div id="content-processes" class="tab-content" style="display: none;">
    <div class="card">
        <div class="card__body">
            <h3 class="text-lg font-semibold mb-4">Notable Processes</h3>
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>PID</th>
                            <th>Name</th>
                            <th>State</th>
                            <th>Memory</th>
                            <th>FDs</th>
                            <th>Flags</th>
                        </tr>
                    </thead>
                    <tbody id="process-table">
                        <tr><td colspan="6" class="text-center py-8 text-muted">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Tab Content: Configs -->
<div id="content-configs" class="tab-content" style="display: none;">
    <div class="card">
        <div class="card__body">
            <h3 class="text-lg font-semibold mb-4">Monitored Config Files</h3>
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Path</th>
                            <th>Size</th>
                            <th>Modified</th>
                            <th>Perms</th>
                            <th>SHA256</th>
                        </tr>
                    </thead>
                    <tbody id="config-table">
                        <tr><td colspan="5" class="text-center py-8 text-muted">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Tab Content: Raw JSON -->
<div id="content-raw" class="tab-content" style="display: none;">
    <div class="card">
        <div class="card__body">
            <h3 class="text-lg font-semibold mb-4">Raw Fingerprint JSON</h3>
            <pre id="raw-json" class="p-4 rounded-lg text-xs overflow-auto max-h-96" style="background: var(--bg-recessed);">Loading...</pre>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const hostname = '{{ hostname }}';
    let memoryChart, loadChart;
    let hostData = null;

    // Tab switching
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(`content-${tabName}`).style.display = 'block';
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        if (tabName === 'events') {
            loadEvents();
        }
    }

    // Get risk class
    function getRiskClass(level) {
        return level ? `risk-${level}` : 'risk-low';
    }

    // Get event type display info
    function getEventTypeInfo(type) {
        const types = {
            'auth_failure': { label: 'Auth Failure', icon: 'user-x', color: 'var(--color-danger)' },
            'brute_force': { label: 'Brute Force', icon: 'alert-octagon', color: '#dc2626' },
            'sudo': { label: 'Sudo Command', icon: 'terminal', color: 'var(--color-info)' },
            'file_access': { label: 'File Access', icon: 'file-warning', color: 'var(--color-warning)' },
            'selinux_denial': { label: 'SELinux Denial', icon: 'shield-x', color: '#8b5cf6' },
            'apparmor_denial': { label: 'AppArmor Denial', icon: 'shield-x', color: '#8b5cf6' }
        };
        return types[type] || { label: type, icon: 'info', color: 'var(--text-muted)' };
    }

    // Chart tick color based on theme
    function getTickColor() {
        return getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim() || '#9ca3af';
    }

    // Initialize charts
    function initCharts() {
        const tickColor = getTickColor();
        const gridColor = 'rgba(75, 85, 99, 0.3)';
        
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    grid: { color: gridColor },
                    ticks: { color: tickColor }
                },
                y: {
                    grid: { color: gridColor },
                    ticks: { color: tickColor }
                }
            },
            plugins: {
                legend: { display: false }
            }
        };

        memoryChart = new Chart(document.getElementById('memory-chart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { 
                ...chartConfig, 
                scales: { 
                    ...chartConfig.scales, 
                    y: { ...chartConfig.scales.y, max: 100 } 
                } 
            }
        });

        loadChart = new Chart(document.getElementById('load-chart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: chartConfig
        });
    }

    // Render risk score sparkline
    function renderRiskSparkline(fingerprints) {
        const canvas = document.getElementById('risk-sparkline');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        
        ctx.clearRect(0, 0, width, height);
        
        const scores = fingerprints.map(f => f.audit_risk_score ?? 0).reverse();
        if (scores.length < 2) return;
        
        const maxScore = Math.max(...scores, 5);
        const range = maxScore || 1;
        
        const padding = 2;
        const chartWidth = width - padding * 2;
        const chartHeight = height - padding * 2;
        const stepX = chartWidth / (scores.length - 1);
        
        const currentScore = scores[scores.length - 1];
        let strokeColor, fillColor;
        if (currentScore >= 31) {
            strokeColor = '#ef4444';
            fillColor = 'rgba(239, 68, 68, 0.2)';
        } else if (currentScore >= 16) {
            strokeColor = '#f97316';
            fillColor = 'rgba(249, 115, 22, 0.2)';
        } else if (currentScore >= 6) {
            strokeColor = '#eab308';
            fillColor = 'rgba(234, 179, 8, 0.2)';
        } else {
            strokeColor = '#10b981';
            fillColor = 'rgba(16, 185, 129, 0.2)';
        }
        
        ctx.beginPath();
        ctx.moveTo(padding, height - padding);
        scores.forEach((score, i) => {
            const x = padding + i * stepX;
            const y = height - padding - (score / range) * chartHeight;
            ctx.lineTo(x, y);
        });
        ctx.lineTo(padding + (scores.length - 1) * stepX, height - padding);
        ctx.closePath();
        ctx.fillStyle = fillColor;
        ctx.fill();
        
        ctx.beginPath();
        scores.forEach((score, i) => {
            const x = padding + i * stepX;
            const y = height - padding - (score / range) * chartHeight;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.strokeStyle = strokeColor;
        ctx.lineWidth = 1.5;
        ctx.stroke();
    }

    // Generate security posture summary
    function generatePostureSummary(audit) {
        const riskScore = audit.risk_score || 0;
        const authFailures = audit.authentication?.failures || 0;
        const bruteForce = audit.authentication?.brute_force_detected || false;
        const sudoCount = audit.privilege_escalation?.sudo_count || 0;
        const sudoDeviation = audit.privilege_escalation?.sudo_deviation_pct || 0;
        const fileAccess = audit.file_integrity?.sensitive_file_access || [];
        const tmpExecs = audit.process_activity?.tmp_executions || 0;
        const devshmExecs = audit.process_activity?.devshm_executions || 0;
        
        let sentences = [];
        let posture = 'HEALTHY';
        let postureColor = 'success';
        let icon = 'shield-check';
        
        if (riskScore >= 31) {
            posture = 'CRITICAL';
            postureColor = 'danger';
            icon = 'shield-alert';
        } else if (riskScore >= 16) {
            posture = 'ELEVATED RISK';
            postureColor = 'warning';
            icon = 'shield-alert';
        } else if (riskScore >= 6) {
            posture = 'CAUTION';
            postureColor = 'warning';
            icon = 'shield';
        }
        
        if (riskScore === 0) {
            sentences.push('This system shows no security concerns.');
        } else {
            sentences.push(`This system shows ${posture.toLowerCase()} with a risk score of ${riskScore}.`);
        }
        
        if (bruteForce) {
            sentences.push(`Brute force attack pattern detected with ${authFailures} authentication failures.`);
        } else if (authFailures > 0) {
            sentences.push(`${authFailures} authentication failure${authFailures > 1 ? 's' : ''} detected in the recent window.`);
        } else {
            sentences.push('Authentication patterns are normal with no failures detected.');
        }
        
        if (sudoDeviation > 200) {
            sentences.push(`Sudo usage is elevated (${sudoCount} commands, ${Math.round(sudoDeviation)}% above baseline).`);
        } else if (sudoCount > 0) {
            sentences.push(`Privilege usage is within normal expectations (${sudoCount} sudo commands).`);
        } else {
            sentences.push('No privilege escalation activity detected.');
        }
        
        const suspiciousFiles = fileAccess.filter(f => f.suspicious).length;
        if (suspiciousFiles > 0) {
            sentences.push(`${suspiciousFiles} suspicious sensitive file access event${suspiciousFiles > 1 ? 's' : ''} detected.`);
        } else if (fileAccess.length > 0) {
            sentences.push(`${fileAccess.length} sensitive file${fileAccess.length > 1 ? 's were' : ' was'} accessed normally.`);
        }
        
        if (tmpExecs > 0 || devshmExecs > 0) {
            let execWarnings = [];
            if (tmpExecs > 0) execWarnings.push(`${tmpExecs} from /tmp`);
            if (devshmExecs > 0) execWarnings.push(`${devshmExecs} from /dev/shm`);
            sentences.push(`Warning: Suspicious executions detected (${execWarnings.join(', ')}).`);
        }
        
        sentences.push(`Overall posture: <strong style="color: var(--color-${postureColor});">${posture}</strong>.`);
        
        const postureIcon = document.getElementById('posture-icon');
        const postureBadge = document.getElementById('posture-badge');
        const postureText = document.getElementById('posture-text');
        
        postureIcon.style.background = `var(--color-${postureColor}-muted)`;
        postureIcon.innerHTML = `<i data-lucide="${icon}" class="w-6 h-6" style="color: var(--color-${postureColor});"></i>`;
        
        postureBadge.style.background = `var(--color-${postureColor}-muted)`;
        postureBadge.style.color = `var(--color-${postureColor})`;
        postureBadge.textContent = posture;
        
        postureText.innerHTML = sentences.join(' ');
        
        lucide.createIcons();
    }

    // Reset audit totals
    async function resetAuditTotals() {
        Modal.confirm('Reset all security counters? This marks current events as acknowledged.', async () => {
            try {
                const response = await fetch(`/api/hosts/${hostname}/reset-audit`, { method: 'POST' });
                if (response.ok) {
                    Toast.success('Counters reset successfully');
                    loadHostData();
                    loadLatestFingerprint();
                    loadEvents();
                } else {
                    const error = await response.json();
                    Toast.error('Reset failed: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                Toast.error('Reset failed: ' + error.message);
            }
        });
    }

    // Load events
    async function loadEvents() {
        const filter = document.getElementById('event-filter').value;
        const showAcknowledged = document.getElementById('show-acknowledged').checked;
        
        let url = `/api/hosts/${hostname}/events?limit=100`;
        if (filter) url += `&type=${filter}`;
        if (showAcknowledged) url += `&include_acknowledged=true`;
        
        try {
            const response = await fetch(url);
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            const events = await response.json();
            
            const listEl = document.getElementById('events-list');
            const emptyEl = document.getElementById('events-empty');
            
            if (events.length === 0) {
                listEl.style.display = 'none';
                emptyEl.style.display = 'block';
            } else {
                listEl.style.display = 'block';
                emptyEl.style.display = 'none';
                
                listEl.innerHTML = events.map(e => {
                    const info = getEventTypeInfo(e.event_type);
                    const details = e.details || {};
                    
                    let detailsHtml = '';
                    if (e.event_type === 'file_access' && details.path) {
                        detailsHtml = `<span class="text-muted">${details.path}</span>`;
                        if (details.process) detailsHtml += ` <span class="text-muted">by ${details.process}</span>`;
                    } else if (e.event_type === 'auth_failure' && details.users?.length) {
                        detailsHtml = `<span class="text-muted">${details.users.join(', ')}</span>`;
                    }
                    
                    return `
                        <div class="p-3 rounded-lg border-l-4 event-type-${e.event_type} ${e.acknowledged ? 'opacity-50' : ''}" style="background: var(--bg-recessed); border-color: var(--border-default);">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i data-lucide="${info.icon}" class="w-5 h-5 mr-3" style="color: ${info.color};"></i>
                                    <div>
                                        <div class="flex items-center">
                                            <span class="font-semibold" style="color: ${info.color};">${info.label}</span>
                                            <span class="ml-2 text-sm text-muted">×${e.count}</span>
                                            ${e.acknowledged ? '<span class="ml-2 text-xs text-muted">(acknowledged)</span>' : ''}
                                        </div>
                                        <div class="text-xs">${detailsHtml}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-muted">${timeAgo(e.captured_at)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                lucide.createIcons();
            }
        } catch (error) {
            console.error('Failed to load events:', error);
        }
    }

    // Acknowledge all events
    async function acknowledgeAllEvents() {
        Modal.confirm('Acknowledge all events?', async () => {
            try {
                const response = await fetch(`/api/hosts/${hostname}/events/acknowledge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    Toast.success('Events acknowledged');
                    loadEvents();
                } else {
                    Toast.error('Failed to acknowledge events');
                }
            } catch (error) {
                Toast.error('Failed to acknowledge events');
            }
        });
    }

    // Load host data
    async function loadHostData() {
        try {
            const response = await fetch(`/api/hosts/${hostname}`);
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            const data = await response.json();
            hostData = data;
            
            // Update cumulative totals
            document.getElementById('total-auth-failures').textContent = data.audit_auth_failures_total || 0;
            document.getElementById('total-sudo-count').textContent = data.audit_sudo_count_total || 0;
            document.getElementById('total-file-access').textContent = data.audit_sensitive_access_total || 0;
            document.getElementById('total-brute-force').textContent = data.audit_brute_force_count || 0;
            
            if (data.audit_totals_since) {
                document.getElementById('totals-since').textContent = 'Since: ' + new Date(data.audit_totals_since).toLocaleString();
            }
            
            // Update charts
            const fingerprints = data.fingerprints || [];
            const recent = fingerprints.slice(0, 50).reverse();
            
            const labels = recent.map(f => {
                const d = new Date(f.captured_at);
                return d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0');
            });
            
            memoryChart.data.labels = labels;
            memoryChart.data.datasets[0].data = recent.map(f => f.memory_percent || 0);
            memoryChart.update();
            
            loadChart.data.labels = labels;
            loadChart.data.datasets[0].data = recent.map(f => f.load_1m || 0);
            loadChart.update();
            
            renderRiskSparkline(recent);
            
            // Update header status
            const latest = fingerprints[0];
            if (latest) {
                let status = 'ok';
                if (latest.exit_code === 2) status = 'critical';
                else if (latest.exit_code === 1) status = 'warning';
                
                document.getElementById('host-status').textContent = `Last seen: ${timeAgo(latest.captured_at)} • Status: ${status.toUpperCase()}`;
                document.getElementById('host-status').className = `text-xs status-${status}`;
                
                // Quick stats
                document.getElementById('stat-memory').textContent = latest.memory_percent ? latest.memory_percent.toFixed(1) + '%' : '-';
                document.getElementById('stat-load').textContent = latest.load_1m ? latest.load_1m.toFixed(2) : '-';
                document.getElementById('stat-processes').textContent = latest.process_count || '-';
                document.getElementById('stat-zombies').textContent = latest.zombie_count || '0';
                document.getElementById('stat-listeners').textContent = latest.listener_count || '-';
                document.getElementById('stat-uptime').textContent = latest.uptime_days ? latest.uptime_days.toFixed(1) + 'd' : '-';
                
                // Risk score
                if (latest.audit_enabled && latest.audit_risk_score !== null) {
                    document.getElementById('stat-risk-card').style.display = '';
                    document.getElementById('stat-risk').textContent = latest.audit_risk_score;
                    
                    const riskBadge = document.getElementById('risk-badge');
                    riskBadge.style.display = '';
                    riskBadge.querySelector('span').className = `px-3 py-1 rounded-full text-sm font-semibold ${getRiskClass(latest.audit_risk_level)}`;
                    document.getElementById('risk-level').textContent = (latest.audit_risk_level || 'low').toUpperCase();
                }
            }
            
            updateLastUpdated();
            
        } catch (error) {
            console.error('Failed to load host data:', error);
        }
    }

    // Load latest fingerprint
    async function loadLatestFingerprint() {
        try {
            const response = await fetch(`/api/hosts/${hostname}/latest`);
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            const result = await response.json();
            const data = result.data;
            
            // Security tab
            const audit = data.audit_summary;
            if (audit && audit.enabled) {
                document.getElementById('security-disabled').style.display = 'none';
                document.getElementById('security-content').style.display = 'block';
                
                // Risk score
                document.getElementById('security-score').textContent = audit.risk_score || 0;
                document.getElementById('risk-score-badge').className = `px-4 py-2 rounded-lg text-lg font-bold ${getRiskClass(audit.risk_level)}`;
                
                generatePostureSummary(audit);
                
                // Stats
                document.getElementById('sec-auth-failures').textContent = audit.authentication?.failures || 0;
                document.getElementById('sec-sudo-count').textContent = audit.privilege_escalation?.sudo_count || 0;
                document.getElementById('sec-file-access').textContent = audit.file_integrity?.sensitive_file_access?.length || 0;
                document.getElementById('sec-selinux').textContent = audit.security_framework?.selinux_avc_denials || 0;
                
                // Learning badge
                const learning = audit.learning;
                const learningBadge = document.getElementById('learning-badge');
                const sampleCount = learning?.sample_count || 0;
                
                if (learning && sampleCount <= 50) {
                    document.getElementById('sample-count').textContent = sampleCount;
                    learningBadge.style.display = '';
                    document.getElementById('learning-label').textContent = sampleCount < 10 ? 'Learning' : 'Calibrating';
                } else {
                    learningBadge.style.display = 'none';
                }
                
                // Brute force alert
                document.getElementById('brute-force-alert').style.display = audit.authentication?.brute_force_detected ? 'flex' : 'none';
                
                // File access table
                const files = audit.file_integrity?.sensitive_file_access || [];
                document.getElementById('file-access-table').innerHTML = files.length ?
                    files.map(f => `
                        <tr>
                            <td class="font-mono text-xs">${f.path}</td>
                            <td>${f.process || '-'}</td>
                            <td class="font-mono">${f.count}</td>
                            <td>${f.suspicious ? '<span class="text-danger">suspicious</span>' : '<span class="text-muted">normal</span>'}</td>
                        </tr>
                    `).join('') :
                    '<tr><td colspan="4" class="text-center py-8 text-muted">No file access events</td></tr>';
                
                // Anomalies
                const anomalies = audit.anomalies || [];
                document.getElementById('anomalies-list').innerHTML = anomalies.length ?
                    anomalies.map(a => `
                        <div class="flex items-start p-3 rounded-lg mb-2" style="background: var(--bg-recessed);">
                            <i data-lucide="alert-circle" class="w-5 h-5 mr-3 mt-0.5" style="color: ${
                                a.severity === 'CRITICAL' ? 'var(--color-danger)' :
                                a.severity === 'HIGH' ? 'var(--color-warning)' : 'var(--color-warning)'
                            };"></i>
                            <div>
                                <div class="font-semibold">${a.type}</div>
                                <div class="text-sm text-muted">${a.description}</div>
                            </div>
                        </div>
                    `).join('') :
                    '<p class="text-muted text-center py-4">No anomalies detected</p>';
                
                // Risk factors
                const riskFactors = audit.risk_factors || [];
                const totalWeight = riskFactors.reduce((sum, f) => sum + f.weight, 0);
                
                document.getElementById('risk-factors-total').textContent = 
                    riskFactors.length ? `${riskFactors.length} factor${riskFactors.length > 1 ? 's' : ''} = ${totalWeight} points` : '';
                
                document.getElementById('risk-factors-list').innerHTML = riskFactors.length ?
                    riskFactors.map(f => {
                        let weightColor = 'warning';
                        if (f.weight >= 10) weightColor = 'danger';
                        else if (f.weight <= 2) weightColor = 'muted';
                        
                        return `
                            <div class="flex items-center justify-between p-3 rounded-lg mb-2" style="background: var(--color-${weightColor}-muted); border: 1px solid var(--color-${weightColor});">
                                <div class="flex items-center">
                                    <i data-lucide="alert-triangle" class="w-4 h-4 mr-3" style="color: var(--color-${weightColor});"></i>
                                    <span>${f.reason}</span>
                                </div>
                                <span class="font-mono font-bold" style="color: var(--color-${weightColor});">+${f.weight}</span>
                            </div>
                        `;
                    }).join('') :
                    `<div class="flex items-center justify-center py-8 text-muted">
                        <i data-lucide="shield-check" class="w-8 h-8 mr-3" style="color: var(--color-success);"></i>
                        <span>No risk factors detected — system is clean</span>
                    </div>`;
                
                lucide.createIcons();
            } else {
                document.getElementById('security-disabled').style.display = 'block';
                document.getElementById('security-content').style.display = 'none';
            }

            // Network table
            const listeners = data.network?.listeners || [];
            document.getElementById('network-table').innerHTML = listeners.length ? 
                listeners.map(l => `
                    <tr>
                        <td class="font-mono">${l.address}</td>
                        <td class="font-mono">${l.port}</td>
                        <td>${l.protocol}</td>
                        <td>${l.process || '-'}</td>
                        <td>${l.unusual ? '<span class="text-warning">unusual</span>' : '<span class="text-muted">normal</span>'}</td>
                    </tr>
                `).join('') :
                '<tr><td colspan="5" class="text-center py-8 text-muted">No listeners</td></tr>';

            // Process table
            const processes = data.process_summary?.notable_processes || [];
            document.getElementById('process-table').innerHTML = processes.length ?
                processes.map(p => `
                    <tr>
                        <td class="font-mono">${p.pid}</td>
                        <td>${p.name}</td>
                        <td>${p.state}</td>
                        <td class="font-mono">${formatBytes(p.memory_mb * 1024 * 1024 || 0)}</td>
                        <td class="font-mono">${p.open_fds || '-'}</td>
                        <td class="text-xs">${p.flag ? `<span class="text-warning">${p.flag}</span>` : ''}</td>
                    </tr>
                `).join('') :
                '<tr><td colspan="6" class="text-center py-8 text-muted">No notable processes</td></tr>';

            // Config table
            const configs = data.config_files || [];
            document.getElementById('config-table').innerHTML = configs.length ?
                configs.map(c => `
                    <tr>
                        <td class="font-mono text-xs">${c.path}</td>
                        <td class="font-mono">${formatBytes(c.size_bytes || 0)}</td>
                        <td class="text-xs">${c.modified || '-'}</td>
                        <td class="font-mono">${c.permissions || '-'}</td>
                        <td class="font-mono text-xs truncate" style="max-width: 150px;" title="${c.checksum}">${c.checksum?.substring(0, 16)}...</td>
                    </tr>
                `).join('') :
                '<tr><td colspan="5" class="text-center py-8 text-muted">No config files tracked</td></tr>';

            // Raw JSON
            document.getElementById('raw-json').textContent = JSON.stringify(data, null, 2);

        } catch (error) {
            console.error('Failed to load fingerprint:', error);
        }
    }

    // Initialize
    initCharts();
    loadHostData();
    loadLatestFingerprint();

    // Auto-refresh
    setInterval(() => {
        loadHostData();
        loadLatestFingerprint();
    }, 30000);
</script>
{% endblock %}
