{% extends "base.html" %}

{% block title %}User Management - C-Sentinel{% endblock %}

{% block header_back %}
{{ back_button('/') }}
{% endblock %}

{% set header_icon = 'users' %}
{% block header_title %}User Management{% endblock %}
{% block header_subtitle %}Manage dashboard users and roles{% endblock %}

{% block nav_items %}
<a href="/admin/sessions" class="nav-link">
    <i data-lucide="monitor-smartphone"></i>
    <span>Sessions</span>
</a>
<a href="/admin/audit" class="nav-link">
    <i data-lucide="scroll-text"></i>
    <span>Audit Log</span>
</a>
<a href="/profile" class="nav-link">
    <i data-lucide="user"></i>
    <span>{{ session.username }}</span>
</a>
<a href="/logout" class="nav-link">
    <i data-lucide="log-out"></i>
    <span>Logout</span>
</a>
{% endblock %}

{% block content %}
<div class="max-w-5xl" style="margin: 0 auto;">
    {# Header with Add User button #}
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-semibold">Users</h2>
        <button onclick="showAddUserModal()" class="btn btn--primary btn--sm">
            <i data-lucide="user-plus"></i>
            <span>Add User</span>
        </button>
    </div>
    
    {# Users Table #}
    <div class="table-wrapper">
        <table class="table" id="users-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th class="hide-mobile">Email</th>
                    <th>Role</th>
                    <th class="hide-mobile">Last Login</th>
                    <th class="hide-mobile">Status</th>
                    <th style="text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody id="users-body">
                <tr>
                    <td colspan="6" class="text-center py-8">
                        <div class="spinner" style="margin: 0 auto;"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

{# Add User Modal Template #}
<template id="add-user-modal-template">
    <form id="add-user-form">
        <div class="form-group">
            <label for="new-username" class="form-label">Username</label>
            <input type="text" id="new-username" name="username" class="form-input" required minlength="3" placeholder="Enter username">
        </div>
        <div class="form-group">
            <label for="new-email" class="form-label">Email (optional)</label>
            <input type="email" id="new-email" name="email" class="form-input" placeholder="user@example.com">
        </div>
        <div class="form-group">
            <label for="new-password" class="form-label">Password</label>
            <input type="password" id="new-password" name="password" class="form-input" required minlength="8" placeholder="Minimum 8 characters">
        </div>
        <div class="form-group">
            <label for="new-role" class="form-label">Role</label>
            <select id="new-role" name="role" class="form-input form-select">
                <option value="viewer">Viewer</option>
                <option value="operator">Operator</option>
                <option value="admin">Admin</option>
            </select>
        </div>
    </form>
</template>
{% endblock %}

{% block scripts %}
<script>
    let currentModal = null;
    
    /**
     * Load users list
     */
    async function loadUsers() {
        try {
            const users = await api('/api/users');
            if (!users) return;
            
            const tbody = document.getElementById('users-body');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <i data-lucide="users" class="empty-state__icon"></i>
                                <h3 class="empty-state__title">No users found</h3>
                            </div>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>
                        <div class="flex items-center gap-2">
                            <i data-lucide="user" style="width: 16px; height: 16px; color: var(--text-muted);"></i>
                            <span class="font-semibold">${user.username}</span>
                        </div>
                    </td>
                    <td class="hide-mobile text-muted">${user.email || '-'}</td>
                    <td>
                        <span class="badge badge--${user.role}">${user.role}</span>
                    </td>
                    <td class="hide-mobile text-muted">
                        ${user.last_login ? timeAgo(user.last_login) : 'Never'}
                    </td>
                    <td class="hide-mobile">
                        ${user.active 
                            ? '<span class="badge badge--active">Active</span>' 
                            : '<span class="badge badge--inactive">Inactive</span>'
                        }
                    </td>
                    <td style="text-align: right;">
                        <div class="flex items-center justify-end gap-2">
                            <button onclick="editUser('${user.username}')" class="btn btn--ghost btn--sm" title="Edit">
                                <i data-lucide="pencil"></i>
                            </button>
                            <button onclick="resetPassword('${user.username}')" class="btn btn--ghost btn--sm" title="Reset Password">
                                <i data-lucide="key"></i>
                            </button>
                            ${user.username !== '{{ session.username }}' ? `
                                <button onclick="deleteUser('${user.username}')" class="btn btn--ghost btn--sm" title="Delete" style="color: var(--color-danger);">
                                    <i data-lucide="trash-2"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
            
            lucide.createIcons();
            
        } catch (error) {
            console.error('Failed to load users:', error);
            Toast.error('Failed to load users');
        }
    }
    
    /**
     * Show add user modal
     */
    function showAddUserModal() {
        const template = document.getElementById('add-user-modal-template');
        const content = template.content.cloneNode(true);
        
        currentModal = Modal.show('Add New User', content.querySelector('form'), {
            footer: `
                <button class="btn btn--secondary" onclick="currentModal.close()">Cancel</button>
                <button class="btn btn--primary" onclick="submitAddUser()">
                    <i data-lucide="user-plus"></i>
                    <span>Create User</span>
                </button>
            `
        });
        
        lucide.createIcons();
    }
    
    /**
     * Submit add user form
     */
    async function submitAddUser() {
        const form = document.getElementById('add-user-form');
        const formData = new FormData(form);
        
        try {
            await api('/api/users', {
                method: 'POST',
                body: JSON.stringify({
                    username: formData.get('username'),
                    email: formData.get('email') || null,
                    password: formData.get('password'),
                    role: formData.get('role')
                })
            });
            
            Toast.success('User created successfully');
            currentModal.close();
            loadUsers();
            
        } catch (error) {
            Toast.error(error.message || 'Failed to create user');
        }
    }
    
    /**
     * Delete user
     */
    function deleteUser(username) {
        Modal.confirm(
            `Are you sure you want to delete user "${username}"? This action cannot be undone.`,
            async () => {
                try {
                    await api(`/api/users/${username}`, { method: 'DELETE' });
                    Toast.success('User deleted');
                    loadUsers();
                } catch (error) {
                    Toast.error(error.message || 'Failed to delete user');
                }
            }
        );
    }
    
    /**
     * Reset user password
     */
    function resetPassword(username) {
        const content = document.createElement('div');
        content.innerHTML = `
            <form id="reset-password-form">
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" name="password" class="form-input" required minlength="8" placeholder="Minimum 8 characters">
                </div>
            </form>
        `;
        
        currentModal = Modal.show(`Reset Password for ${username}`, content, {
            footer: `
                <button class="btn btn--secondary" onclick="currentModal.close()">Cancel</button>
                <button class="btn btn--primary" onclick="submitResetPassword('${username}')">Reset Password</button>
            `
        });
    }
    
    async function submitResetPassword(username) {
        const form = document.getElementById('reset-password-form');
        const password = form.querySelector('input[name="password"]').value;
        
        try {
            await api(`/api/users/${username}/password`, {
                method: 'POST',
                body: JSON.stringify({ password })
            });
            
            Toast.success('Password reset successfully');
            currentModal.close();
            
        } catch (error) {
            Toast.error(error.message || 'Failed to reset password');
        }
    }
    
    /**
     * Edit user
     */
    function editUser(username) {
        // TODO: Implement edit user modal
        Toast.info('Edit user functionality coming soon');
    }
    
    // Initial load
    loadUsers();
</script>
{% endblock %}
