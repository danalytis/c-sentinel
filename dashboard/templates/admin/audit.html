{% extends "base.html" %}

{% block title %}Audit Log - C-Sentinel{% endblock %}

{% block header_back %}
{{ back_button('/') }}
{% endblock %}

{% block header_icon_block %}<i data-lucide="scroll-text"></i>{% endblock %}
{% block header_title %}Audit Log{% endblock %}
{% block header_subtitle %}Track all user actions{% endblock %}

{% block nav_items %}
<a href="/admin/users" class="nav-link">
    <i data-lucide="users"></i>
    <span>Users</span>
</a>
<a href="/admin/sessions" class="nav-link">
    <i data-lucide="monitor-smartphone"></i>
    <span>Sessions</span>
</a>
<a href="/profile" class="nav-link">
    <i data-lucide="user"></i>
    <span>{{ session.username }}</span>
</a>
<a href="/logout" class="nav-link">
    <i data-lucide="log-out"></i>
    <span>Logout</span>
</a>
{% endblock %}

{% block content %}
<style>
    .audit-filters {
        display: flex;
        align-items: flex-end;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-default);
    }
    .audit-filters .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
    }
    .audit-filters .filter-group label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .audit-filters .filter-group select {
        min-width: 160px;
    }
    .audit-filters .entry-count {
        margin-left: auto;
        font-size: 0.875rem;
        color: var(--text-muted);
    }
    
    .action-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.625rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    .action-badge__dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    
    /* Action badge colours */
    .action-badge--login { background: #14532d; color: #4ade80; }
    .action-badge--login .action-badge__dot { background: #4ade80; }
    
    .action-badge--logout { background: #14532d; color: #4ade80; }
    .action-badge--logout .action-badge__dot { background: #4ade80; }
    
    .action-badge--login_failed { background: #7f1d1d; color: #f87171; }
    .action-badge--login_failed .action-badge__dot { background: #f87171; }
    
    .action-badge--create_user { background: #7c2d12; color: #fb923c; }
    .action-badge--create_user .action-badge__dot { background: #fb923c; }
    
    .action-badge--update_user { background: #7c2d12; color: #fb923c; }
    .action-badge--update_user .action-badge__dot { background: #fb923c; }
    
    .action-badge--delete_user { background: #7f1d1d; color: #f87171; }
    .action-badge--delete_user .action-badge__dot { background: #f87171; }
    
    .action-badge--2fa_enabled { background: #1e3a5f; color: #93c5fd; }
    .action-badge--2fa_enabled .action-badge__dot { background: #93c5fd; }
    
    .action-badge--2fa_disabled { background: #1e3a5f; color: #93c5fd; }
    .action-badge--2fa_disabled .action-badge__dot { background: #93c5fd; }
    
    .action-badge--create_api_key { background: #374151; color: #9ca3af; }
    .action-badge--create_api_key .action-badge__dot { background: #9ca3af; }
    
    .action-badge--delete_api_key { background: #374151; color: #9ca3af; }
    .action-badge--delete_api_key .action-badge__dot { background: #9ca3af; }
    
    .action-badge--password_changed { background: #1e3a5f; color: #93c5fd; }
    .action-badge--password_changed .action-badge__dot { background: #93c5fd; }
    
    .action-badge--revoke_session { background: #1e3a5f; color: #93c5fd; }
    .action-badge--revoke_session .action-badge__dot { background: #93c5fd; }
    
    .action-badge--default { background: #374151; color: #9ca3af; }
    .action-badge--default .action-badge__dot { background: #9ca3af; }
    
    .audit-table td {
        padding: 0.875rem 1rem;
        vertical-align: middle;
    }
    .audit-table th {
        padding: 0.75rem 1rem;
        text-transform: uppercase;
        font-size: 0.6875rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        color: var(--text-muted);
    }
    
    .legend {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
        padding-top: 1rem;
        margin-top: 1rem;
        border-top: 1px solid var(--border-default);
    }
    .legend-title {
        font-size: 0.875rem;
        font-weight: 600;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8125rem;
        color: var(--text-secondary);
    }
    .legend-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
</style>

<div class="card">
    <div class="card__body">
        {# Filters Row #}
        <div class="audit-filters">
            <div class="filter-group">
                <label>Action Type</label>
                <select id="action-filter" class="form-input form-select" onchange="loadAuditLog()">
                    <option value="">All Actions</option>
                    <option value="login">Login</option>
                    <option value="logout">Logout</option>
                    <option value="login_failed">Failed Login</option>
                    <option value="password_changed">Password Changed</option>
                    <option value="2fa_enabled">2FA Enabled</option>
                    <option value="2fa_disabled">2FA Disabled</option>
                    <option value="create_user">Create User</option>
                    <option value="update_user">Update User</option>
                    <option value="delete_user">Delete User</option>
                    <option value="create_api_key">Create API Key</option>
                    <option value="delete_api_key">Delete API Key</option>
                </select>
            </div>
            <div class="filter-group">
                <label>User</label>
                <select id="user-filter" class="form-input form-select" onchange="loadAuditLog()">
                    <option value="">All Users</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Time Range</label>
                <select id="time-filter" class="form-input form-select" onchange="loadAuditLog()">
                    <option value="24h">Last 24 hours</option>
                    <option value="7d">Last 7 days</option>
                    <option value="30d">Last 30 days</option>
                    <option value="all">All time</option>
                </select>
            </div>
            <div class="entry-count">
                <span id="entry-count">-</span> entries
            </div>
        </div>
        
        {# Audit Log Table #}
        <div class="table-wrapper">
            <table class="table audit-table">
                <thead>
                    <tr>
                        <th style="width: 170px;">Timestamp</th>
                        <th style="width: 100px;">User</th>
                        <th style="width: 130px;">Action</th>
                        <th>Details</th>
                        <th style="width: 130px; text-align: right;">IP Address</th>
                    </tr>
                </thead>
                <tbody id="audit-body">
                    <tr>
                        <td colspan="5" class="text-center py-8">
                            <div class="spinner" style="margin: 0 auto;"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        {# Pagination #}
        <div class="flex items-center justify-between mt-4">
            <button onclick="loadPage(currentPage - 1)" class="btn btn--secondary btn--sm" id="prev-btn" disabled>
                <i data-lucide="chevron-left"></i>
                <span>Previous</span>
            </button>
            <span class="text-sm text-muted" id="page-info">Page 1 of 1</span>
            <button onclick="loadPage(currentPage + 1)" class="btn btn--secondary btn--sm" id="next-btn">
                <span>Next</span>
                <i data-lucide="chevron-right"></i>
            </button>
        </div>
        
        {# Action Types Legend #}
        <div class="legend">
            <span class="legend-title">Action Types</span>
            <span class="legend-item">
                <span class="legend-dot" style="background: #4ade80;"></span>
                Login/Logout
            </span>
            <span class="legend-item">
                <span class="legend-dot" style="background: #f87171;"></span>
                Failed Login
            </span>
            <span class="legend-item">
                <span class="legend-dot" style="background: #fb923c;"></span>
                User Management
            </span>
            <span class="legend-item">
                <span class="legend-dot" style="background: #93c5fd;"></span>
                Security Actions
            </span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    const pageSize = 50;
    
    // Action badge HTML
    function getActionBadge(action) {
        const labels = {
            'login': 'Login',
            'logout': 'Logout',
            'login_failed': 'Failed Login',
            'password_changed': 'Password Changed',
            '2fa_enabled': '2fa_enabled',
            '2fa_disabled': '2fa_disabled',
            'create_user': 'Create User',
            'update_user': 'Update User',
            'delete_user': 'Delete User',
            'create_api_key': 'create_api_key',
            'delete_api_key': 'delete_api_key',
            'revoke_session': 'Revoke Session',
        };
        
        const label = labels[action] || action;
        const className = labels[action] ? action : 'default';
        
        return `<span class="action-badge action-badge--${className}">
            <span class="action-badge__dot"></span>
            ${label}
        </span>`;
    }
    
    function formatDetails(details) {
        if (!details) return '-';
        if (typeof details === 'string') {
            try {
                details = JSON.parse(details);
            } catch {
                return details;
            }
        }
        
        const parts = [];
        if (details.ip) parts.push(`from ${details.ip}`);
        if (details['2fa'] !== undefined) parts.push(`2fa: ${details['2fa']}`);
        if (details.new_user) parts.push(`Created user "${details.new_user}" with role ${details.role}`);
        if (details.target_user !== undefined) {
            let changes = details.changes || details.field || '';
            if (details.active !== undefined) changes = `active: ${details.active}`;
            parts.push(`Updated user #${details.target_user}${changes ? ': ' + changes : ''}`);
        }
        if (details.disabled_user) parts.push(`Disabled user "${details.disabled_user}"`);
        if (details.username && !details.new_user && !details.ip) parts.push(`Attempted username: ${details.username}`);
        if (details.key_prefix) {
            let keyInfo = `{"key_prefix":"${details.key_prefix}"`;
            if (details.name) keyInfo += `,"name":"${details.name}"`;
            keyInfo += '}';
            parts.push(keyInfo);
        }
        
        if (parts.length === 0) {
            // Fallback: show raw JSON nicely
            const str = JSON.stringify(details);
            if (str === '{}' || str === 'null') return '-';
            return str.replace(/[{}"]/g, '').replace(/,/g, ', ').replace(/:/g, ': ');
        }
        
        return parts.join(', ');
    }
    
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const mins = String(date.getMinutes()).padStart(2, '0');
        const secs = String(date.getSeconds()).padStart(2, '0');
        return `${day}/${month}/${year},&nbsp;${hours}:${mins}:${secs}`;
    }
    
    async function loadUsers() {
        try {
            const users = await api('/api/users');
            if (!users) return;
            
            const select = document.getElementById('user-filter');
            users.forEach(u => {
                const option = document.createElement('option');
                option.value = u.id;
                option.textContent = u.username;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Failed to load users:', error);
        }
    }
    
    async function loadAuditLog() {
        currentPage = 1;
        await loadPage(1);
    }
    
    async function loadPage(page) {
        if (page < 1) return;
        
        const actionFilter = document.getElementById('action-filter').value;
        const userFilter = document.getElementById('user-filter').value;
        const timeRange = document.getElementById('time-filter').value;
        
        try {
            let url = `/api/admin/audit-log?page=${page}&limit=${pageSize}&time_range=${timeRange}`;
            if (actionFilter) url += `&action=${actionFilter}`;
            if (userFilter) url += `&user_id=${userFilter}`;
            
            const data = await api(url);
            if (!data) return;
            
            const entries = data.entries || [];
            const total = data.total || entries.length;
            const tbody = document.getElementById('audit-body');
            
            document.getElementById('entry-count').textContent = total;
            
            if (entries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <i data-lucide="scroll-text" class="empty-state__icon"></i>
                                <h3 class="empty-state__title">No audit entries</h3>
                                <p class="empty-state__description">No matching entries found</p>
                            </div>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }
            
            tbody.innerHTML = entries.map(entry => `
                <tr>
                    <td class="text-muted font-mono" style="font-size: 0.8125rem; white-space: nowrap;">${formatDate(entry.created_at)}</td>
                    <td class="font-semibold">${entry.username || '-'}</td>
                    <td>${getActionBadge(entry.action)}</td>
                    <td class="text-muted" style="font-size: 0.8125rem;">${formatDetails(entry.details)}</td>
                    <td class="text-right font-mono" style="font-size: 0.8125rem;">${entry.ip_address || '-'}</td>
                </tr>
            `).join('');
            
            currentPage = page;
            const totalPages = Math.ceil(total / pageSize) || 1;
            
            document.getElementById('prev-btn').disabled = page <= 1;
            document.getElementById('next-btn').disabled = page >= totalPages;
            document.getElementById('page-info').textContent = `Page ${page} of ${totalPages}`;
            
            lucide.createIcons();
            
        } catch (error) {
            console.error('Failed to load audit log:', error);
            Toast.error('Failed to load audit log');
        }
    }
    
    // Initial load
    loadUsers();
    loadAuditLog();
</script>
{% endblock %}
