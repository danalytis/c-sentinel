{% extends "base.html" %}

{% block title %}Active Sessions - C-Sentinel{% endblock %}

{% block header_back %}
{{ back_button('/') }}
{% endblock %}

{% block header_icon_block %}<i data-lucide="monitor-smartphone"></i>{% endblock %}
{% block header_title %}Active Sessions{% endblock %}
{% block header_subtitle %}Manage logged-in users and devices{% endblock %}

{% block nav_items %}
<a href="/admin/users" class="nav-link">
    <i data-lucide="users"></i>
    <span>Users</span>
</a>
<a href="/admin/audit" class="nav-link">
    <i data-lucide="scroll-text"></i>
    <span>Audit Log</span>
</a>
<a href="/profile" class="nav-link">
    <i data-lucide="user"></i>
    <span>{{ session.username }}</span>
</a>
<a href="/logout" class="nav-link">
    <i data-lucide="log-out"></i>
    <span>Logout</span>
</a>
{% endblock %}

{% block content %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }
    @media (max-width: 768px) {
        .stats-grid { grid-template-columns: 1fr; }
    }
    .stat-box {
        background: var(--bg-surface);
        border: 1px solid var(--border-default);
        border-radius: var(--border-radius-lg);
        padding: 1.25rem 1.5rem;
    }
    .stat-box__label {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
    }
    .stat-box__value {
        font-size: 2rem;
        font-weight: 600;
        font-family: var(--font-mono);
    }
    .stat-box__value--green { color: #4ade80; }
    .stat-box__value--yellow { color: #facc15; }
    
    .sessions-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
    .sessions-header h2 {
        font-size: 1.125rem;
        font-weight: 600;
    }
    .sessions-header .actions {
        display: flex;
        gap: 0.75rem;
    }
    
    .session-table th {
        padding: 0.75rem 1rem;
        text-transform: uppercase;
        font-size: 0.6875rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        color: var(--text-muted);
    }
    .session-table td {
        padding: 1rem;
        vertical-align: middle;
    }
    
    .user-cell {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .user-cell__dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    .user-cell__dot--active { background: #4ade80; }
    .user-cell__dot--recent { background: #3b82f6; }
    .user-cell__dot--idle { background: #6b7280; }
    .user-cell__info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    .user-cell__name {
        font-weight: 600;
    }
    
    .device-cell {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .device-cell i {
        color: var(--text-muted);
    }
    .device-cell__info {
        display: flex;
        flex-direction: column;
    }
    .device-cell__browser {
        font-size: 0.875rem;
    }
    .device-cell__os {
        font-size: 0.75rem;
        color: var(--text-muted);
    }
    
    .role-badge {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        font-size: 0.6875rem;
        font-weight: 500;
    }
    .role-badge--admin { background: #7c3aed; color: #e9d5ff; }
    .role-badge--operator { background: #0891b2; color: #cffafe; }
    .role-badge--viewer { background: #374151; color: #9ca3af; }
    
    .current-badge {
        color: #c084fc;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .legend {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
        padding: 1rem 1.25rem;
        background: var(--bg-surface);
        border: 1px solid var(--border-default);
        border-radius: var(--border-radius-lg);
        margin-top: 1.5rem;
    }
    .legend-title {
        font-size: 0.875rem;
        font-weight: 600;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8125rem;
        color: var(--text-secondary);
    }
    .legend-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
</style>

{# Stats Cards #}
<div class="stats-grid">
    <div class="stat-box">
        <div class="stat-box__label">Active Sessions</div>
        <div class="stat-box__value" id="stat-total">-</div>
    </div>
    <div class="stat-box">
        <div class="stat-box__label">Unique Users</div>
        <div class="stat-box__value" id="stat-unique">-</div>
    </div>
    <div class="stat-box">
        <div class="stat-box__label">Active Now (5m)</div>
        <div class="stat-box__value stat-box__value--yellow" id="stat-active">-</div>
    </div>
</div>

{# Sessions Table #}
<div class="card">
    <div class="card__body">
        <div class="sessions-header">
            <h2>Sessions</h2>
            <div class="actions">
                <button onclick="cleanupExpired()" class="btn btn--secondary btn--sm">
                    <i data-lucide="trash-2"></i>
                    <span>Cleanup Expired</span>
                </button>
                <button onclick="revokeAllOthers()" class="btn btn--danger btn--sm">
                    <i data-lucide="shield-off"></i>
                    <span>Revoke All Others</span>
                </button>
            </div>
        </div>
        
        <div class="table-wrapper">
            <table class="table session-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Device / Browser</th>
                        <th>IP Address</th>
                        <th>Last Active</th>
                        <th>Expires</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody id="sessions-body">
                    <tr>
                        <td colspan="6" class="text-center py-8">
                            <div class="spinner" style="margin: 0 auto;"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{# Session Status Legend #}
<div class="legend">
    <span class="legend-title">Session Status</span>
    <span class="legend-item">
        <span class="legend-dot" style="background: #4ade80;"></span>
        Active now (&lt; 5 min)
    </span>
    <span class="legend-item">
        <span class="legend-dot" style="background: #3b82f6;"></span>
        Recent (&lt; 1 hour)
    </span>
    <span class="legend-item">
        <span class="legend-dot" style="background: #6b7280;"></span>
        Idle
    </span>
    <span class="legend-item">
        <span class="legend-dot" style="background: #c084fc;"></span>
        Current Session (You)
    </span>
</div>
{% endblock %}

{% block scripts %}
<script>
    function parseUserAgent(ua) {
        if (!ua) return { browser: 'Unknown', os: 'Unknown' };
        
        let browser = 'Unknown';
        let os = 'Unknown';
        
        // Detect browser
        if (ua.includes('Chrome') && !ua.includes('Edg')) browser = 'Chrome';
        else if (ua.includes('Firefox')) browser = 'Firefox';
        else if (ua.includes('Safari') && !ua.includes('Chrome')) browser = 'Safari';
        else if (ua.includes('Edg')) browser = 'Edge';
        else if (ua.includes('Opera') || ua.includes('OPR')) browser = 'Opera';
        
        // Detect OS
        if (ua.includes('Windows')) os = 'Windows';
        else if (ua.includes('Mac OS') || ua.includes('Macintosh')) os = 'macOS';
        else if (ua.includes('Linux') && !ua.includes('Android')) os = 'Linux';
        else if (ua.includes('Android')) os = 'Android';
        else if (ua.includes('iPhone') || ua.includes('iPad')) os = 'iOS';
        
        return { browser, os };
    }
    
    function getActivityStatus(lastActive) {
        if (!lastActive) return 'idle';
        const mins = (Date.now() - new Date(lastActive).getTime()) / 60000;
        if (mins < 5) return 'active';
        if (mins < 60) return 'recent';
        return 'idle';
    }
    
    function formatLastActive(lastActive) {
        if (!lastActive) return '-';
        const mins = (Date.now() - new Date(lastActive).getTime()) / 60000;
        if (mins < 1) return 'Now';
        if (mins < 60) return `${Math.floor(mins)} min ago`;
        const hours = mins / 60;
        if (hours < 24) return `${Math.floor(hours)} hours ago`;
        return `${Math.floor(hours / 24)} days ago`;
    }
    
    function formatExpires(expires) {
        if (!expires) return '-';
        const date = new Date(expires);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }
    
    async function loadSessions() {
        try {
            const data = await api('/api/admin/sessions');
            if (!data) return;
            
            // Update stats
            document.getElementById('stat-total').textContent = data.total || 0;
            document.getElementById('stat-unique').textContent = data.unique_users || 0;
            document.getElementById('stat-active').textContent = data.active_now || 0;
            
            const sessions = data.sessions || [];
            const tbody = document.getElementById('sessions-body');
            
            if (sessions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <i data-lucide="monitor-smartphone" class="empty-state__icon"></i>
                                <h3 class="empty-state__title">No active sessions</h3>
                            </div>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }
            
            tbody.innerHTML = sessions.map(s => {
                const ua = parseUserAgent(s.user_agent);
                const status = s.is_current ? 'active' : getActivityStatus(s.last_active);
                const roleBadgeClass = s.role === 'admin' ? 'admin' : s.role === 'operator' ? 'operator' : 'viewer';
                
                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <span class="user-cell__dot user-cell__dot--${status}"></span>
                                <div class="user-cell__info">
                                    <span class="user-cell__name">${s.username}</span>
                                    <span class="role-badge role-badge--${roleBadgeClass}">${s.role}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="device-cell">
                                <i data-lucide="monitor" style="width: 16px; height: 16px;"></i>
                                <div class="device-cell__info">
                                    <span class="device-cell__browser">${ua.browser}</span>
                                    <span class="device-cell__os">${ua.os}</span>
                                </div>
                            </div>
                        </td>
                        <td class="font-mono" style="font-size: 0.875rem;">${s.ip_address || '-'}</td>
                        <td style="color: ${status === 'active' ? '#4ade80' : 'var(--text-muted)'};">${formatLastActive(s.last_active)}</td>
                        <td class="text-muted">${formatExpires(s.expires_at)}</td>
                        <td style="text-align: right;">
                            ${s.is_current 
                                ? '<span class="current-badge">Current</span>' 
                                : `<button onclick="revokeSession(${s.id})" class="btn btn--ghost btn--sm" title="Revoke session" style="color: var(--color-danger);">
                                    <i data-lucide="x-circle"></i>
                                </button>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');
            
            lucide.createIcons();
            
        } catch (error) {
            console.error('Failed to load sessions:', error);
            Toast.error('Failed to load sessions');
        }
    }
    
    async function revokeSession(sessionId) {
        Modal.confirm('Revoke this session? The user will be logged out.', async () => {
            try {
                const response = await fetch(`/api/admin/sessions/${sessionId}`, { method: 'DELETE' });
                if (response.ok) {
                    Toast.success('Session revoked');
                    loadSessions();
                } else {
                    const error = await response.json();
                    Toast.error(error.error || 'Failed to revoke session');
                }
            } catch (error) {
                Toast.error('Failed to revoke session');
            }
        });
    }
    
    async function revokeAllOthers() {
        Modal.confirm('Revoke all other sessions? All other users will be logged out.', async () => {
            try {
                const response = await fetch('/api/admin/sessions/revoke-all-others', { method: 'POST' });
                if (response.ok) {
                    Toast.success('All other sessions revoked');
                    loadSessions();
                } else {
                    const error = await response.json();
                    Toast.error(error.error || 'Failed to revoke sessions');
                }
            } catch (error) {
                Toast.error('Failed to revoke sessions');
            }
        });
    }
    
    async function cleanupExpired() {
        try {
            const response = await fetch('/api/admin/sessions/cleanup', { method: 'POST' });
            if (response.ok) {
                const data = await response.json();
                Toast.success(`Cleaned up ${data.deleted || 0} expired sessions`);
                loadSessions();
            } else {
                Toast.error('Failed to cleanup sessions');
            }
        } catch (error) {
            Toast.error('Failed to cleanup sessions');
        }
    }
    
    // Initial load
    loadSessions();
</script>
{% endblock %}
