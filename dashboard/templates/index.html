{% extends "base.html" %}

{% block title %}C-Sentinel Dashboard{% endblock %}

{% block header_stats %}
<div class="site-header__stats">
    <div class="stat-block">
        <div class="stat-block__value" id="stat-total">-</div>
        <div class="stat-block__label">Hosts</div>
    </div>
    <div class="stat-block">
        <div class="stat-block__value stat-block__value--success" id="stat-active">-</div>
        <div class="stat-block__label">Active</div>
    </div>
    <div class="stat-block">
        <div class="stat-block__value stat-block__value--danger" id="stat-critical">-</div>
        <div class="stat-block__label">Critical</div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="host-grid" id="hosts-container">
    {# Loading state #}
    <div class="empty-state" style="grid-column: 1 / -1;">
        <div class="spinner" style="width: 32px; height: 32px; margin: 0 auto 1rem;"></div>
        <p class="text-muted">Loading hosts...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const REFRESH_INTERVAL = 30000;

    /**
     * Load and render host cards
     */
    async function loadHosts() {
        try {
            const hosts = await api('/api/hosts');
            if (!hosts) return;
            
            const container = document.getElementById('hosts-container');
            
            if (hosts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i data-lucide="server-off" class="empty-state__icon"></i>
                        <h3 class="empty-state__title">No hosts yet</h3>
                        <p class="empty-state__description">Configure a sentinel agent to start monitoring</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = hosts.map(host => renderHostCard(host)).join('');
            lucide.createIcons();
            updateLastUpdated();
            
        } catch (error) {
            console.error('Failed to load hosts:', error);
            Toast.error('Failed to load hosts');
        }
    }

    /**
     * Render a single host card
     */
    function renderHostCard(host) {
        const statusClass = host.status || 'stale';
        const dotClass = statusClass === 'ok' ? 'host-card__dot--ok' :
                         statusClass === 'warning' ? 'host-card__dot--warning' :
                         statusClass === 'critical' ? 'host-card__dot--critical' :
                         'host-card__dot--stale';
        
        const iconClass = `host-card__icon--${statusClass}`;
        const statusIcon = statusClass === 'ok' ? 'check-circle' :
                           statusClass === 'warning' ? 'alert-triangle' :
                           statusClass === 'critical' ? 'alert-octagon' :
                           'clock';
        
        const lastSeen = host.last_seen ? timeAgo(host.last_seen) : 'never';
        
        // Risk badge
        let riskBadge = '';
        if (host.audit_enabled && host.audit_risk_score !== null) {
            const riskLevel = host.audit_risk_level || 'low';
            riskBadge = `
                <div class="risk-banner risk-badge--${riskLevel}">
                    <span class="flex items-center gap-2">
                        <i data-lucide="shield"></i>
                        Risk: ${riskLevel.toUpperCase()}
                    </span>
                    <span class="font-mono font-bold">${host.audit_risk_score}</span>
                </div>
            `;
        }
        
        // Warnings
        let warnings = [];
        if (host.unusual_port_count > 0) {
            warnings.push(`<span class="text-warning"><i data-lucide="alert-triangle" style="width:12px;height:12px;display:inline;vertical-align:-2px;"></i> ${host.unusual_port_count} unusual ports</span>`);
        }
        if (host.audit_brute_force) {
            warnings.push(`<span class="text-danger"><i data-lucide="alert-octagon" style="width:12px;height:12px;display:inline;vertical-align:-2px;"></i> Brute force detected</span>`);
        }
        
        return `
            <a href="/host/${host.hostname}" class="host-card">
                <div class="card card__body">
                    <div class="host-card__header">
                        <div class="host-card__status">
                            <span class="host-card__dot ${dotClass}"></span>
                            <h3 class="host-card__name">${host.hostname}</h3>
                        </div>
                        <div class="host-card__icon ${iconClass}">
                            <i data-lucide="${statusIcon}"></i>
                        </div>
                    </div>
                    
                    <div class="host-card__metrics">
                        <div class="host-card__metric">
                            <div class="host-card__metric-label">Memory</div>
                            <div class="host-card__metric-value">${host.memory_percent ? host.memory_percent.toFixed(1) + '%' : '-'}</div>
                        </div>
                        <div class="host-card__metric">
                            <div class="host-card__metric-label">Load</div>
                            <div class="host-card__metric-value">${host.load_1m ? host.load_1m.toFixed(2) : '-'}</div>
                        </div>
                        <div class="host-card__metric">
                            <div class="host-card__metric-label">Processes</div>
                            <div class="host-card__metric-value">${host.process_count || '-'}</div>
                        </div>
                        <div class="host-card__metric">
                            <div class="host-card__metric-label">Listeners</div>
                            <div class="host-card__metric-value">${host.listener_count || '-'}</div>
                        </div>
                    </div>
                    
                    ${riskBadge}
                    
                    ${warnings.length > 0 ? `
                        <div class="mt-3 text-xs flex flex-col gap-1">
                            ${warnings.join('')}
                        </div>
                    ` : ''}
                    
                    <div class="host-card__footer">
                        <span>Uptime: ${host.uptime_days ? host.uptime_days.toFixed(1) + 'd' : '-'}</span>
                        <span>${lastSeen}</span>
                    </div>
                </div>
            </a>
        `;
    }

    /**
     * Load dashboard stats
     */
    async function loadStats() {
        try {
            const stats = await api('/api/stats');
            if (!stats) return;
            
            document.getElementById('stat-total').textContent = stats.total_hosts;
            document.getElementById('stat-active').textContent = stats.active_hosts;
            document.getElementById('stat-critical').textContent = stats.critical_hosts;
            
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    }

    // Initial load
    loadHosts();
    loadStats();

    // Auto-refresh
    setInterval(() => {
        loadHosts();
        loadStats();
    }, REFRESH_INTERVAL);
</script>
{% endblock %}
